{"version":3,"file":"ExpoBrownfieldStateModule.js","sourceRoot":"","sources":["../src/ExpoBrownfieldStateModule.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,mBAAmB,EAAE,MAAM,MAAM,CAAC;AAE3C,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,QAAQ,EAAE,MAAM,OAAO,CAAC;AAOzD,MAAM,yBAAyB,GAAG,mBAAmB,CACnD,2BAA2B,CAC5B,CAAC;AAEF,MAAM,iBAAiB,GAAG,IAAI,GAAG,EAAe,CAAC;AAEjD,4BAA4B;AAE5B,SAAS,eAAe,CAAC,GAAW;IAClC,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;QAChC,iBAAiB,CAAC,GAAG,CAAC,GAAG,EAAE,yBAAyB,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC,CAAC;IAC5E,CAAC;IACD,OAAO,iBAAiB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACpC,CAAC;AAED;;;;GAIG;AACH,MAAM,UAAU,mBAAmB,CAAU,GAAW;IACtD,MAAM,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;IACnC,MAAM,KAAK,GAAG,KAAK,EAAE,GAAG,EAAE,CAAC;IAC3B,OAAO,KAAK,KAAK,IAAI,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAE,KAAW,CAAC;AACnD,CAAC;AAED;;;;;GAKG;AACH,MAAM,UAAU,mBAAmB,CAAU,GAAW,EAAE,KAAQ;IAChE,MAAM,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;IACnC,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;AACnB,CAAC;AAED;;;;GAIG;AACH,MAAM,UAAU,iBAAiB,CAAC,GAAW;IAC3C,yBAAyB,CAAC,iBAAiB,CAAC,GAAG,CAAC,CAAC;IACjD,iBAAiB,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;AAChC,CAAC;AAED;;;;;;GAMG;AACH,MAAM,UAAU,sBAAsB,CACpC,GAAW,EACX,QAAwC;IAExC,MAAM,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;IACnC,MAAM,YAAY,GAAG,KAAK,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC,KAAoB,EAAE,EAAE;QACxE,QAAQ,CAAC,KAAK,CAAC,CAAC;IAClB,CAAC,CAAC,CAAC;IAEH,OAAO;QACL,MAAM,EAAE,GAAG,EAAE,CAAC,YAAY,CAAC,MAAM,EAAE;KACpC,CAAC;AACJ,CAAC;AAED;;;;;;;GAOG;AACH,MAAM,UAAU,cAAc,CAC5B,GAAW,EACX,YAAgB;IAEhB,MAAM,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;IAEnC,MAAM,CAAC,KAAK,EAAE,QAAQ,CAAC,GAAG,QAAQ,CAAgB,GAAG,EAAE;QACrD,MAAM,YAAY,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;QACjC,IAAI,YAAY,KAAK,IAAI,IAAI,YAAY,KAAK,SAAS,EAAE,CAAC;YACxD,IAAI,YAAY,KAAK,SAAS,EAAE,CAAC;gBAC/B,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;gBACxB,OAAO,YAAY,CAAC;YACtB,CAAC;YAED,OAAO,SAAS,CAAC;QACnB,CAAC;QAED,OAAO,YAAiB,CAAC;IAC3B,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,IAAI,YAAY,GAAG,KAAK,CAAC,WAAW,CAClC,QAAQ,EACR,CAAC,KAAgD,EAAE,EAAE;YACnD,QAAQ,CAAC,KAAK,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC;QAC7B,CAAC,CACF,CAAC;QAEF,MAAM,wBAAwB,GAAG,yBAAyB,CAAC,WAAW,CACpE,gBAAgB,EAChB,CAAC,KAAwB,EAAE,EAAE;YAC3B,IAAI,KAAK,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;gBACtB,MAAM,QAAQ,GAAG,yBAAyB,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;gBAC/D,iBAAiB,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;gBAErC,YAAY,CAAC,MAAM,EAAE,CAAC;gBACtB,YAAY,GAAG,QAAQ,CAAC,WAAW,CACjC,QAAQ,EACR,CAAC,KAAgD,EAAE,EAAE;oBACnD,QAAQ,CAAC,KAAK,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC;gBAC7B,CAAC,CACF,CAAC;gBAEF,QAAQ,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC,CAAC;YACrC,CAAC;QACH,CAAC,CACF,CAAC;QAEF,OAAO,GAAG,EAAE;YACV,YAAY,CAAC,MAAM,EAAE,CAAC;YACtB,wBAAwB,CAAC,MAAM,EAAE,CAAC;QACpC,CAAC,CAAC;IACJ,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC;IAEZ,MAAM,cAAc,GAAG,WAAW,CAChC,CAAC,QAA0C,EAAE,EAAE;QAC7C,MAAM,UAAU,GACd,OAAO,QAAQ,KAAK,UAAU,CAAC,CAAC,CAAE,QAAuC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;QAC9F,eAAe,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;IACvC,CAAC,EACD,CAAC,GAAG,EAAE,KAAK,CAAC,CACb,CAAC;IAEF,OAAO,CAAC,KAAK,EAAE,cAAc,CAAC,CAAC;AACjC,CAAC;AAED,gCAAgC","sourcesContent":["import { requireNativeModule } from 'expo';\nimport type { EventSubscription } from 'expo-modules-core';\nimport { useCallback, useEffect, useState } from 'react';\n\nimport type {\n  ExpoBrownfieldStateModuleSpec,\n  KeyRecreatedEvent,\n} from './ExpoBrownfieldStateModule.types';\n\nconst ExpoBrownfieldStateModule = requireNativeModule<ExpoBrownfieldStateModuleSpec>(\n  'ExpoBrownfieldStateModule'\n);\n\nconst sharedObjectCache = new Map<string, any>();\n\n// SECTION: Shared State API\n\nfunction getSharedObject(key: string): any {\n  if (!sharedObjectCache.has(key)) {\n    sharedObjectCache.set(key, ExpoBrownfieldStateModule.getSharedState(key));\n  }\n  return sharedObjectCache.get(key);\n}\n\n/**\n * Gets the value of shared state for a given key.\n *\n * @param key The key to get the value for.\n */\nexport function getSharedStateValue<T = any>(key: string): T | undefined {\n  const state = getSharedObject(key);\n  const value = state?.get();\n  return value === null ? undefined : (value as T);\n}\n\n/**\n * Sets the value of shared state for a given key.\n *\n * @param key The key to set the value for.\n * @param value The value to be set.\n */\nexport function setSharedStateValue<T = any>(key: string, value: T): void {\n  const state = getSharedObject(key);\n  state.set(value);\n}\n\n/**\n * Deletes the shared state for a given key.\n *\n * @param key The key to delete the shared state for.\n */\nexport function deleteSharedState(key: string): void {\n  ExpoBrownfieldStateModule.deleteSharedState(key);\n  sharedObjectCache.delete(key);\n}\n\n/**\n * Adds a listener for changes to the shared state for a given key.\n *\n * @param key The key to add the listener for.\n * @param callback The callback to be called when the shared state changes.\n * @returns A subscription object that can be used to remove the listener.\n */\nexport function addSharedStateListener<T = any>(\n  key: string,\n  callback: (value: T | undefined) => void\n): EventSubscription {\n  const state = getSharedObject(key);\n  const subscription = state.addListener('change', (event: T | undefined) => {\n    callback(event);\n  });\n\n  return {\n    remove: () => subscription.remove(),\n  };\n}\n\n/**\n * Hook to observe and set the value of shared state for a given key.\n * Provides a synchronous API similar to `useState`.\n *\n * @param key The key to get the value for.\n * @param initialValue The initial value to be used if the shared state is not set.\n * @returns A tuple containing the value and a function to set the value.\n */\nexport function useSharedState<T = any>(\n  key: string,\n  initialValue?: T\n): [T | undefined, (value: T | ((prev: T | undefined) => T)) => void] {\n  const state = getSharedObject(key);\n\n  const [value, setValue] = useState<T | undefined>(() => {\n    const currentValue = state.get();\n    if (currentValue === null || currentValue === undefined) {\n      if (initialValue !== undefined) {\n        state.set(initialValue);\n        return initialValue;\n      }\n\n      return undefined;\n    }\n\n    return currentValue as T;\n  });\n\n  useEffect(() => {\n    let subscription = state.addListener(\n      'change',\n      (event: Record<string, T | undefined> | undefined) => {\n        setValue(event?.['value']);\n      }\n    );\n\n    const keyRecreatedSubscription = ExpoBrownfieldStateModule.addListener(\n      'onKeyRecreated',\n      (event: KeyRecreatedEvent) => {\n        if (event.key === key) {\n          const newState = ExpoBrownfieldStateModule.getSharedState(key);\n          sharedObjectCache.set(key, newState);\n\n          subscription.remove();\n          subscription = newState.addListener(\n            'change',\n            (event: Record<string, T | undefined> | undefined) => {\n              setValue(event?.['value']);\n            }\n          );\n\n          setValue(getSharedStateValue(key));\n        }\n      }\n    );\n\n    return () => {\n      subscription.remove();\n      keyRecreatedSubscription.remove();\n    };\n  }, [state]);\n\n  const setSharedValue = useCallback(\n    (newValue: T | ((prev: T | undefined) => T)) => {\n      const valueToSet =\n        typeof newValue === 'function' ? (newValue as (prev: T | undefined) => T)(value) : newValue;\n      getSharedObject(key).set(valueToSet);\n    },\n    [key, value]\n  );\n\n  return [value, setSharedValue];\n}\n\n// END SECTION: Shared State API\n"]}